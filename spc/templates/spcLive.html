{% extends "base.html" %}
{% block title %}SPC Chart and Distribution{% endblock %}
{% block content %}
    <!--<div id="myDiv" style="width:1200px;height:250px;"></div>-->
    <div id="myDiv"></div>
    <script>
        ROOT = document.getElementById("myDiv")
        machinename = "{{ machinename|safe }}"
        machineID= "{{ machineID|safe  }}"
        duration={{ duration|safe }}
        x = {{ dateTime | safe }}
        plotParameter = {{ plotParameter|safe }}
        envparameter = "{{ envparameter|safe }}"
        title = "{{  title|safe }}"
        ylabel = "{{ ylabel|safe }}"


        {% if machinename == 'fanuc' %}
            paraIndex= "{{ paraIndex|safe }}"
            //console.log("HELLO FANUC")
        {% elif machinename == 'moldmaster' %}
            tipID = "{{ tipID|safe }}"
            fieldID = "{{ fieldID|safe }}"
            //console.log("HELLO MOLDMASTER")
        {% elif machinename == 'mouldflo' %}
            manifoldID = "{{ manifoldID|safe }}"
            channelID = "{{ channelID|safe }}"
            fieldID = "{{ fieldID|safe }}"
        {% elif machinename == 'motan' %}
            fieldID = "{{ fieldID|safe }}"
        {% elif machinename == 'conair' %}
            fieldID = "{{ fieldID|safe }}"
        {% elif machinename == 'cda' %}
            cdaID = "{{ cdaID|safe }}"
            fieldID = "{{ fieldID|safe }}"
        {% endif %}

        {% if sp != none %}
            setPointValue = x.map(xItem =>{return {{ sp|safe }}})
            sp= {{ sp|safe }}
        {% else %}
            sp = 0
            setPointValue = x.map(xItem =>{return sp})
        {% endif %}

        {% if noCL != None %}
            noCL={{ noCL | safe }}
        {% else  %}
            noCL = 0 //SHOW CL AND SP
        {% endif %}

        {%  if lcl != None %}
            lcl = {{ lcl | safe | tojson }}
                {% else %}
            lcl = 0
        {% endif %}

        {%  if ucl != None %}
            ucl = {{ ucl | safe | tojson }}
                {% else %}
            ucl = 0
        {% endif %}

        {% if freq != None %}
            freq = {{ freq | safe | tojson }}
                {% else %}
            freq = 60000
        {% endif %}

        //console.log("MACHINENAME: ", machinename)
        //console.log("UPPERLIMIT: ", ucl)
        //console.log("LOWERLIMIT: ", lcl)
        //console.log("SETPOINT: ", sp)
        //console.log("DURATION: ", duration)
        //console.log("FREQ: ", freq)
        {#  setPointValue = x.map(xItem =>{return {{ sp|safe }}}) #}

        {#
        console.log("MACHINENAME: ", resp.machineName)
        console.log("DATETIME: ", resp.datetime)
        console.log("FREQ: ", freq)
        console.log("UPPERLIMIT: ", resp.upperLimit)
        console.log("LOWERLIMIT: ", resp.lowerLimit)
        //GET PARAMETERS KEY
        listKeyParameter = getListOfKeyParameter(resp.parameters)
        parameterName = listKeyParameter[0]
        drawChart(resp.datetime, resp.parameters[listKeyParameter[0]], resp.upperLimit, resp.lowerLimit)
        #}

        drawChart(x,plotParameter,ucl, lcl, setPointValue)

        function drawChart(x,plotParameter, ucl, lcl, setPointValue){
            //console.log("DRAWING CHART")
            var parameter = {
                x: x,
                y: plotParameter,
                name: envparameter,
                type: 'scatter'
            }

            var setPoint =
            {
                x: x,
                y: setPointValue,
                name: 'set point',
                type: 'scatter'
            }

            var CL =
            {
                type: 'scatter',
                //x: ['2020-07-24 14:10:05','2020-07-24 14:30:05',null, '2020-07-24 14:10:05','2020-07-24 14:30:05'],
                x:[x[0], x[x.length -1], null, x[0],x[x.length -1]],
                y: [lcl, lcl,null, ucl, ucl],
                mode: 'lines',
                name: 'LCL/UCL',
                showlegend: true,
                line: {
                    color: 'red',
                    width: 2,
                    dash: 'dash'
                }
            }

            var histo = {
                type: 'histogram',
                //x: chartDateTime,
                y: plotParameter,
                name: 'Distribution',
                orientation: 'h',
                marker: {
                    color: 'blue',
                    line: {
                        color: 'white',
                        width: 1
                    }
                },
                xaxis: 'x2',
                yaxis: 'y2'
            }


            //var data = [parameter, upperLimitLine, lowerLimitLine, histo]
            var data
            if (noCL == 1) {
                //console.log("NOCLSP")
                data = [parameter, histo]
            }else{ //NO CL and SP
                //console.log("YESCLSP")
                data = [parameter, setPoint, CL, histo]
            }
            var layout = {
                title: title,
                showlegend: true,
                legend:{
                   x: 0.5,
                   y: -0.8
                },
                xaxis: {
                    title: "Time",
                    domain: [0, 0.7], // 0 to 70% of width
                    zeroline: false
                },
                yaxis: {
                    //range: [50,200],
                    title: ylabel,
                    autorange: true,
                    zeroline: false
                },
                xaxis2: {
                domain: [0.8, 1], // 70 to 100% of width
                showline: showline = true,
                title: "Frequency"
                },
                yaxis2: {
                    anchor: 'x2',
                    showticklabels: true,
                    title:ylabel
                }


            }

            var config = {responsive: true, displaylogo:false}
            Plotly.newPlot(ROOT, data, layout, config)
        }


        function getListOfKeyParameter(respParameters){
            var keyParameter = new Array()
            for (var i in resp.parameters){
                var key = i;
                keyParameter.push(key)
                //console.log("KEY: ", key) //temperature
            }
            return keyParameter
        }

        function reRender(){
            {#myurl={{ url_for('restdatageneratorApplication.default') }}
            <a href = {{ url_for('find_question' ,question_id=1) }}>Question 1</a>#}
            //console.log("INSIDE RERENDER")
            //console.log("MACHINENAME: ", machinename)
            //console.log("DURATION: ", duration)
            var myurl
            switch(machinename){
                case "envdata":
                    myurl = "{{ url_for('externalrestapiApplication.env_live_json',duration=duration) }}"
                    break
                case "fanuc":
                    myurl = "{{ url_for('externalrestapiApplication.fanuc_live_json',machineID=machineID, paraIndex=paraIndex, duration=duration) }}"
                    break
                case "moldmaster":
                    myurl = "{{ url_for('moldmasterapiApplication.moldmaster_live_json',machineID=machineID, tipID=tipID, fieldID=fieldID, duration=duration) }}"
                    break
                case "mouldflo":
                    myurl = "{{ url_for('mouldfloapiApplication.mouldflo_live_json',machineID=machineID, manifoldID=manifoldID, channelID=channelID, fieldID=fieldID, duration=duration) }}"
                    break
                case "motan":
                    myurl = "{{ url_for('motanapiApplication.motan_live_json',machineID=machineID, fieldID=fieldID, duration=duration) }}"
                    break
                case "conair":
                    myurl = "{{ url_for('conairapiApplication.conair_live_json',machineID=machineID, fieldID=fieldID, duration=duration) }}"
                    break
                case "cda":
                    myurl = "{{ url_for('cdaapiApplication.cda_live_json', cdaID=cdaID, fieldID=fieldID, duration=duration)}}"
                    break
                default:
            }
            //console.log("MYURL: ", myurl)
            $.ajax({
                type: "GET",
                url: myurl,
                dataType: 'json'
            }).done(function(jsondata, status, xhr){
                //console.log("RESPONSE: ", jsondata);
                //x = jsondata[2]
                var x
                var plotParameter
                if (machinename == "envdata"){
                    x = jsondata[2]
                    if (envparameter == "temperature"){
                        plotParameter = jsondata[0]}
                    else{
                        plotParameter = jsondata[1]
                    }
                }
                else if (machinename == "fanuc"){
                    x = jsondata[1]
                    plotParameter = jsondata[0]
                }
                else if (machinename == "moldmaster"){
                    plotParameter = jsondata[0] //plotparameter
                    x = jsondata[1] //time
                    //console.log("MOLDMASTER")
                    //console.log("STATUS: ", xhr.status)
                }
                else if(machinename == "mouldflo"){
                    plotParameter= jsondata[0]
                    x = jsondata[1]
                    //console.log("MOULDFLO")
                    //console.log("STATUS: ", xhr.status)
                }
                else if(machinename == "motan"){
                    plotParameter = jsondata[0]
                    x = jsondata[1]
                    //console.log("MOTAN")
                    //console.log("STATUS: ", xhr.status)
                }
                else if(machinename == "conair"){
                    plotParameter = jsondata[0]
                    x = jsondata[1]
                    //console.log("MOTAN")
                    //console.log("STATUS: ", xhr.status)
                }
                else if(machinename == "cda"){
                    plotParameter = jsondata[0]
                    x = jsondata[1]
                    //console.log("CDA")
                    //console.log("STATUS: ", xhr.status)
                }
                //console.log("TYPE OF X", typeof x)
                //console.log("LENGTH OF X", x.length)
                {# setPointValue = x.map(xItem =>{return {{ sp|safe }}}) #}
                drawChart(x,plotParameter,ucl, lcl, setPointValue)
                //console.log("TEMPERATURE: ", jsondata[0])
                //console.log("HUMIDITY: ", jsondata[1])
                //console.log("DATETIME: ", jsondata[2])
            }).fail(function(xhr, status, error){
                console.log("AJAX FAILED")
            })
        }

        

        setInterval(reRender, freq)

    </script>
{% endblock %}